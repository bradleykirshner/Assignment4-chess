<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chessboard with Piece Images</title>
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/@babel/standalone@7.10.3/babel.min.js"
      crossorigin
    ></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,stage-3">
      // Model: Starting state of the chessboard in 2D array
      const initialGameState = [
        ["r", "n", "b", "q", "k", "b", "n", "r"],
        ["p", "p", "p", "p", "p", "p", "p", "p"],
        ["", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", ""],
        ["", "", "", "", "", "", "", ""],
        ["P", "P", "P", "P", "P", "P", "P", "P"],
        ["R", "N", "B", "Q", "K", "B", "N", "R"],
      ];

      // Mapping of chess pieces to their respective image URLs
      const pieceImages = {
        r: "https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg",
        n: "https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg",
        b: "https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg",
        q: "https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg",
        k: "https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg",
        p: "https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg",
        R: "https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg",
        N: "https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg",
        B: "https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg",
        Q: "https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg",
        K: "https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg",
        P: "https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg",
      };

      function Game() {
        const [game, setGame] = React.useState(initialGameState);
        const [selectedSquare, setSelectedSquare] = React.useState(null);
        const [step, setStep] = React.useState(0);

        function isValidPawnMove(startRow, startCol, endRow, endCol, piece) {
          const direction = piece === "P" ? -1 : 1;
          const startRowCorrect = piece === "P" ? 6 : 1;
          const moveForwardOne =
            startRow + direction === endRow &&
            startCol === endCol &&
            game[endRow][endCol] === "";
          const moveForwardTwo =
            startRow === startRowCorrect &&
            startRow + 2 * direction === endRow &&
            startCol === endCol &&
            game[startRow + direction][startCol] === "" &&
            game[endRow][endCol] === "";
          const captureMove =
            startRow + direction === endRow &&
            (startCol + 1 === endCol || startCol - 1 === endCol) &&
            game[endRow][endCol] &&
            game[endRow][endCol].toLowerCase() !==
              game[startRow][startCol].toLowerCase();

          return moveForwardOne || moveForwardTwo || captureMove;
        }

        function isValidRookMove(startRow, startCol, endRow, endCol, piece) {
          if (startRow === endRow) {
            // Horizontal move
            const step = startCol < endCol ? 1 : -1;
            for (let col = startCol + step; col !== endCol; col += step) {
              if (game[startRow][col] !== "") return false; // Blocked by another piece
            }
            return true;
          } else if (startCol === endCol) {
            // Vertical move
            const step = startRow < endRow ? 1 : -1;
            for (let row = startRow + step; row !== endRow; row += step) {
              if (game[row][startCol] !== "") return false; // Blocked by another piece
            }
            return true;
          }
          return false; // Invalid move
        }

        // Handle square click for moving pieces
        function handleClick(row, col) {
          setStep(step + 1);

          if (selectedSquare) {
            const newGame = game.map((row) => row.slice());
            const [startRow, startCol] = selectedSquare; // Destructure here
            const piece = game[startRow][startCol]; // Declare piece here

            if (
              piece.toLowerCase() === "p" &&
              isValidPawnMove(startRow, startCol, row, col, piece)
            ) {
              const newGame = game.map((row) => row.slice());
              newGame[row][col] = piece;
              newGame[startRow][startCol] = "";
              setGame(newGame);
              setSelectedSquare(null);
            } else if (
              piece.toLowerCase() === "r" &&
              isValidRookMove(startRow, startCol, row, col, piece)
            ) {
              const newGame = game.map((row) => row.slice());
              newGame[row][col] = piece;
              newGame[startRow][startCol] = "";
              setGame(newGame);
              setSelectedSquare(null);
            } else {
              setSelectedSquare(null); // Deselect if the move is invalid
            }
          } else {
            if (game[row][col]) {
              setSelectedSquare([row, col]);
            }
          }
        }

        return (
          <div>
            <Board
              game={game}
              onSquareClick={handleClick}
              selectedSquare={selectedSquare}
            />
          </div>
        );
      }

      // View: Board and buttons reflecting the game state
      function Board({ game, onSquareClick, selectedSquare }) {
        return (
          <div>
            {game.map((row, rowIndex) => (
              <div key={rowIndex} style={{ display: "flex" }}>
                {row.map((value, colIndex) => (
                  <Square
                    key={colIndex}
                    value={value}
                    onClick={() => onSquareClick(rowIndex, colIndex)}
                    isLight={(rowIndex + colIndex) % 2 === 0}
                    isSelected={
                      selectedSquare &&
                      selectedSquare[0] === rowIndex &&
                      selectedSquare[1] === colIndex
                    }
                  />
                ))}
              </div>
            ))}
          </div>
        );
      }

      function Square({ value, onClick, isLight, isSelected }) {
        const squareStyle = {
          width: "80px",
          height: "80px",
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
          cursor: "pointer",
          backgroundColor: isSelected
            ? "#ffeb3b"
            : isLight
            ? "#f0d9b5"
            : "#b58863",
          border: "1px solid #999",
        };

        // Display the piece image or an empty square
        const pieceDisplay = () => {
          if (value) {
            return (
              <img
                src={pieceImages[value]}
                alt={value}
                style={{ width: "70px", height: "70px" }}
              />
            );
          }
          return null;
        };

        return (
          <button style={squareStyle} onClick={onClick}>
            {pieceDisplay()}
          </button>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<Game />);
    </script>
  </body>
</html>
